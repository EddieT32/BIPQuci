# BIPQuick

This is BIPQuick - the Branch-wise Iterative Partitioning (Quick) method.For the time being, I will use this README to describe the work that has yet to be done on BIPQuick, rather than how to use it.  

In its current state, on 9/3/2019 at 2:15pm, BIPQuick is being developed as satisfying three conditions.  The conditions are defined by the different ways a "full" partition can be found within a given system.

The first condition, called OPTIMAL, is satisfied when the partitioning threshold can be found exactly at a node in the system.  When this condition is true, a full partition can be formed by the contributing subnetwork to that node.  A test case, OPTIMAL.inp, was contrived such that the OPTIMAL condition is true for 3 partitions of an simple network.  Branches, dividers, and loops were considered within the development for the OPTIMAL test case.  

Using the OPTIMAL.inp test case, BIPQuick was designed to execute the following workflow: pre-processing, partition-search, post-processing.  In the pre-processing phase (which is managed by separate, currently broken scripts), a SWMM input file is parsed into two 2D arrays.  One of these arrays contains the "node" objects (junctions, outlets, dividers, etc) in the SWMM system, and the other array contains the "link" objects (mostly conduits).  It is worth noting that only the hydraulics (necessarily directed) of the SWMM system are being considered.  These two arrays consitute the starting point for the BIPQuick routine.  They are "unordered" meaning that the order of elements in each array are organized based on the labeling scheme of the engineer, not necessarily based on topological connectivity.  The purpose of BIPQuick is to provide this order.  

The partition-search portion of the BIPQuick workflow has its own order of operations.  Initially, each node in the network is given a weight value that reflects the cumulative length of links that flow into that node.  Boolean flags are used to ensure that each link only follows one flowpath for systems that contain closed loops.  A partition threshold can be surmised by the ratio between the maximum weight that exists in that system (i.e. the outlet in systems with one outfall) and the number of partitions desired.  This ratio represents the "quantity of link" that should be allocated to each parallel processor to best approximate balanced computational load. In the OPTIMAL test case used in the initial BIPQuick development, the SWMM system was designed such that the partition threshold value was equal to the weight value at a "root" node.  A recursive function that traverses the upstream subnetwork is called on this root node, storing the "watershed" of the given node in a separate container.  The function also turns off the flags that enable that subnetwork to be visable by the remainder of the network.  In doing this, a strictly sized, necessarily connected portion of the network has been separated, or partitioned, from the larger network.

To futher partition the now reduced network, the remaining nodes must have their cumulative weight recalculated.  The partition threshold should remain the same, as the network size has been reduced exactly by the ratio of max weight to available processors that the partition threshold was calculated from in the first place.  Each time the partition threshold is found in the system, that "root node" becomes the locus for the next subnetwork traversal and sequestration into a container.  Iteratively, and preferentially partitioning the branches of a network, the network is divied up into containers each holding one partition's worth of link. 

Once the number of containers equals the number of partitions required, the third step, post-processing is engaged.  Each container contains an exclusive section of the network, but nodes at the boundary between containers exist in multiple containers.  This creates the need for some clunky logic to ensure that each link is represented exclusively by one container. Finally, the containers are reassembled into two 2D arrays that represent the original system in a topologically cogent way.  That is, the nodes and links are ordered in the final array such that, when allocated to a distributed memory parallel processor, the amount of communication between processors is minimized.  

The second condition governing BIPQuicks development and algorithm path, called EDGE 1, deals when the partitioning threshold is not found exactly at any node, but can be found along a link between two nodes.  In the EDGE 1 case, a new, phantom, node is placed along the link at the location where this node's cumulative weight is exactly equal to the partitioning threshold, essentially inducing the OPTIMAL case.  This induction does not change the hydraulic structure of the system, only its topology.
